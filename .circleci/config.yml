version: 2

general:
# Uncomment the following to specify only a specific branch
#   branches:
#     only:
#       - dev # specific branch
#       - /dev-.*/ # or regexes

machine:
  timezone: America/New_York
  environment:
    # from https://developer.salesforce.com/docs/atlas.en-us.sfdx_setup.meta/sfdx_setup/sfdx_setup_install_cli_standalone.htm
    # and https://developer.salesforce.com/media/salesforce-cli/manifest.json
    DX_CLI_URL: https://developer.salesforce.com/media/salesforce-cli/sfdx-v5.7.6-d42cf65-linux-amd64.tar.xz
    SFDX_DISABLE_ENCRYPTION: true

dependencies:
  override:
    openssl enc -nosalt -aes-256-cbc -d -in assets/server.key.enc -out assets/server.key -base64 -K $DECRYPTION_KEY -iv $DECRYPTION_IV


test:
  override:
    - sfdx force --help
    - sfdx force:org:create -s -f config/project-scratch-def.json -a circle_build_$CIRCLE_BUILD_NUM
    - sfdx force:source:push -u circle_build_$CIRCLE_BUILD_NUM
    - mkdir -p $CIRCLE_TEST_REPORTS/junit
    - sfdx force:apex:test:run -c -d $CIRCLE_TEST_REPORTS/junit -r junit
  post:
    - sfdx force:org:delete -u circle_build_$CIRCLE_BUILD_NUM -p

### Uncomment the following if performing deployments
deployment:
  override:
    - sfdx force:source:convert -r force-app -d testDeploy
    - . cleanupDeploy.sh
    - sfdx force:mdapi:deploy -d testDeploy/ -u deploy -w 2
